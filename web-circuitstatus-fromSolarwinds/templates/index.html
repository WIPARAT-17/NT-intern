<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Report Generator</title>
    <style>
        body {
            font-family: 'THSarabunNew', sans-serif; /* à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸Ÿà¸­à¸™à¸•à¹Œà¸–à¸¹à¸à¹‚à¸«à¸¥à¸”à¸«à¸£à¸·à¸­à¸¡à¸µà¹ƒà¸™à¸£à¸°à¸šà¸š */
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-size: 1.2rem;
            line-height: 1.6;
        }
        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 700px; /* à¹€à¸à¸´à¹ˆà¸¡à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢ */
            max-height: 95vh; /* à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡ */
            overflow-y: auto; /* à¹€à¸à¸´à¹ˆà¸¡ scrollbar à¸–à¹‰à¸²à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹€à¸à¸´à¸™ */
        }
        h1 {
            color: #1e88e5;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        input[type="file"] {
            display: none;
        }
        .file-upload-label {
            background-color: #1e88e5;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .file-upload-label:hover {
            background-color: #1565c0;
        }
        #file-name {
            margin-top: 10px;
            color: #555;
            font-size: 1rem;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        button {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem; /* à¸›à¸£à¸±à¸šà¸‚à¸™à¸²à¸”à¸Ÿà¸­à¸™à¸•à¹Œà¸›à¸¸à¹ˆà¸¡ */
            transition: background-color 0.3s;
            flex-grow: 1; /* à¸—à¸³à¹ƒà¸«à¹‰à¸›à¸¸à¹ˆà¸¡à¸‚à¸¢à¸²à¸¢à¹€à¸•à¹‡à¸¡à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ */
            max-width: 200px; /* à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸›à¸¸à¹ˆà¸¡ */
        }
        #submit-button {
            background-color: #4caf50;
            color: white;
        }
        #submit-button:hover:not([disabled]) {
            background-color: #43a047;
        }
        #cancel-button {
            background-color: #f44336;
            color: white;
            display: none; /* Hide by default */
        }
        #cancel-button:hover:not([disabled]) {
            background-color: #d32f2f;
        }
        #download-button {
            background-color: #03a9f4; /* Blue for download */
            color: white;
            display: none; /* Hide by default */
        }
        #download-button:hover:not([disabled]) {
            background-color: #0288d1;
        }
        button[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status-area {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            display: none; /* Hide by default */
            text-align: left; /* à¸ˆà¸±à¸”à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ à¸²à¸¢à¹ƒà¸™à¹ƒà¸«à¹‰à¸Šà¸´à¸”à¸‹à¹‰à¸²à¸¢ */
        }
        #status-message {
            font-size: 1.2rem;
            color: #1976d2;
            margin-bottom: 1rem;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 25px;
        }
        .progress-bar {
            width: 0%;
            background-color: #64b5f6;
            height: 100%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 25px;
            font-weight: bold;
        }
        #progress-text {
            margin-top: 10px;
            color: #555;
            font-size: 1rem;
        }
        #log-area {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            max-height: 200px; /* à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¸‚à¸­à¸‡ Log */
            overflow-y: auto; /* à¹€à¸à¸´à¹ˆà¸¡ scrollbar */
            font-family: monospace; /* à¹ƒà¸Šà¹‰à¸Ÿà¸­à¸™à¸•à¹Œ monospace à¸ªà¸³à¸«à¸£à¸±à¸š log */
            font-size: 0.9rem;
            white-space: pre-wrap; /* à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ log à¸‚à¸¶à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰ */
            text-align: left;
            word-break: break-all; /* à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹† à¸¥à¹‰à¸™ */
        }
        #log-area div {
            margin-bottom: 2px; /* à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸šà¸£à¸£à¸—à¸±à¸” log */
        }
        /* Log message colors based on prefix */
        .log-success { color: #4CAF50; } /* à¹€à¸‚à¸µà¸¢à¸§ */
        .log-error { color: #F44336; } /* à¹à¸”à¸‡ */
        .log-warning { color: #FF9800; } /* à¸ªà¹‰à¸¡ */
        .log-info { color: #2196F3; } /* à¸Ÿà¹‰à¸² */
        .log-critical { color: #D32F2F; font-weight: bold; } /* à¹à¸”à¸‡à¹€à¸‚à¹‰à¸¡ */

        #results-area {
            margin-top: 2rem;
            display: none;
            text-align: left;
        }
        #summary-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #summary-list li {
            margin-bottom: 5px;
        }
        .status-icon {
            font-weight: bold;
            font-size: 1.5em;
            vertical-align: middle;
        }
        .success-icon {
            color: #4caf50;
        }
        .failure-icon {
            color: #f44336;
        }
        .warning-icon {
            color: #ff9800; /* à¸ªà¸µà¸ªà¹‰à¸¡à¸ªà¸³à¸«à¸£à¸±à¸š Warning */
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Custumer Interface Summary Report by Hour</h1>
    <div class="form-group">
        <form id="upload-form">
            <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
            <label for="excel_file" class="file-upload-label">
                à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ Excel
            </label>
            <div id="file-name">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ</div>
        </form>
    </div>
    <div class="button-group">
        <button id="submit-button" type="submit" form="upload-form" disabled>Export File</button>
        <button id="cancel-button">à¸¢à¸à¹€à¸¥à¸´à¸</button>
        <button id="download-button" disabled>à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™ (ZIP)</button>
    </div>
    
    <div id="status-area">
        <div id="status-message"></div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="progress-text"></div>
        <div id="log-area"></div>
    </div>

    <div id="results-area">
        <h3>à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£Export</h3>
        <ul id="summary-list">
        </ul>
    </div>
</div>

<script>
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('excel_file');
    const submitButton = document.getElementById('submit-button');
    const cancelButton = document.getElementById('cancel-button');
    const downloadButton = document.getElementById('download-button');
    const fileNameDisplay = document.getElementById('file-name');
    const statusArea = document.getElementById('status-area');
    const statusMessage = document.getElementById('status-message');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const logArea = document.getElementById('log-area');
    const resultsArea = document.getElementById('results-area');
    const summaryList = document.getElementById('summary-list');
    
    let statusIntervalId;
    let logIntervalId;
    let currentJobId = null;

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameDisplay.textContent = fileInput.files[0].name;
            submitButton.disabled = false;
        } else {
            fileNameDisplay.textContent = 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ';
            submitButton.disabled = true;
        }
        // à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¸¡à¹ˆ à¹ƒà¸«à¹‰à¸‹à¹ˆà¸­à¸™à¸ªà¸–à¸²à¸™à¸°à¹à¸¥à¸°à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹€à¸à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        statusArea.style.display = 'none';
        resultsArea.style.display = 'none';
        downloadButton.style.display = 'none';
        downloadButton.disabled = true;
        cancelButton.style.display = 'none';
        summaryList.innerHTML = '';
        logArea.innerHTML = ''; // à¸¥à¹‰à¸²à¸‡ log à¹€à¸à¹ˆà¸²
        clearIntervals(); // à¸«à¸¢à¸¸à¸” interval à¹€à¸à¹ˆà¸²à¸«à¸²à¸à¸¡à¸µ
    });

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const file = fileInput.files[0];
        if (!file) {
            alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ Excel à¸à¹ˆà¸­à¸™');
            return;
        }

        // à¸£à¸µà¹€à¸‹à¹‡à¸• UI à¸à¹ˆà¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ
        submitButton.disabled = true;
        cancelButton.style.display = 'inline-block';
        cancelButton.disabled = false;
        downloadButton.style.display = 'none'; // à¸‹à¹ˆà¸­à¸™à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ
        downloadButton.disabled = true;
        
        statusArea.style.display = 'block';
        resultsArea.style.display = 'none';
        statusMessage.innerHTML = 'à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹à¸¥à¸°à¹€à¸£à¸´à¹ˆà¸¡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥...';
        progressBar.style.width = '0%';
        progressBar.textContent = '';
        progressText.textContent = '';
        summaryList.innerHTML = '';
        logArea.innerHTML = ''; // à¸¥à¹‰à¸²à¸‡ log à¹€à¸à¹ˆà¸²
        clearIntervals(); // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¹„à¸”à¹‰à¸«à¸¢à¸¸à¸” interval à¹€à¸à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§

        const formData = new FormData();
        formData.append('excel_file', file);

        try {
            const response = await fetch('/generate_report', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server returned an error');
            }

            const data = await response.json();
            currentJobId = data.job_id;

            statusMessage.innerHTML = `à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ <b>${file.name}</b> à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸‚à¸¶à¹‰à¸™à¹à¸¥à¹‰à¸§...`;

            // à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸¶à¸‡à¸ªà¸–à¸²à¸™à¸°
            statusIntervalId = setInterval(fetchStatus, 1000);
            // à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸¶à¸‡ Log
            logIntervalId = setInterval(fetchLogs, 500);

        } catch (error) {
            statusMessage.innerHTML = `âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­: ${error.message}`;
            progressBar.style.width = '0%';
            progressBar.textContent = '';
            progressText.textContent = '';
            submitButton.disabled = false;
            cancelButton.style.display = 'none';
            downloadButton.style.display = 'none';
            clearIntervals();
        }
    });

    cancelButton.addEventListener('click', async () => {
        if (currentJobId) {
            cancelButton.disabled = true;
            statusMessage.innerHTML = 'à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸„à¸³à¸‚à¸­à¸¢à¸à¹€à¸¥à¸´à¸...';
            try {
                const response = await fetch(`/cancel/${currentJobId}`, { method: 'POST' });
                if (response.ok) {
                    console.log('Cancel request sent successfully');
                    // fetchStatus à¸ˆà¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸–à¸²à¸™à¸° 'canceled'
                } else {
                    const errorData = await response.json();
                    statusMessage.innerHTML = `âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸„à¸³à¸‚à¸­à¸¢à¸à¹€à¸¥à¸´à¸à¹„à¸”à¹‰: ${errorData.error || 'Unknown error'}`;
                    cancelButton.disabled = false;
                }
            } catch (error) {
                statusMessage.innerHTML = 'âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¢à¸à¹€à¸¥à¸´à¸: ' + error.message;
                cancelButton.disabled = false;
            }
        }
    });

    downloadButton.addEventListener('click', () => {
        if (currentJobId) {
            // à¹€à¸¡à¸·à¹ˆà¸­à¸„à¸¥à¸´à¸à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” à¹ƒà¸«à¹‰à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¹€à¸£à¸´à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”
            window.location.href = `/download_report/${currentJobId}`;
            // à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ disabled à¸›à¸¸à¹ˆà¸¡à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” à¹€à¸à¸£à¸²à¸°à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸‹à¹‰à¸³à¹„à¸”à¹‰
            // à¹à¸¥à¸°à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ statusMessage à¹€à¸à¸£à¸²à¸°à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§
        }
    });

    function clearIntervals() {
        if (statusIntervalId) {
            clearInterval(statusIntervalId);
            statusIntervalId = null;
        }
        if (logIntervalId) {
            clearInterval(logIntervalId);
            logIntervalId = null;
        }
        cancelButton.style.display = 'none'; // à¸‹à¹ˆà¸­à¸™à¸›à¸¸à¹ˆà¸¡à¸¢à¸à¹€à¸¥à¸´à¸à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥
    }

    async function fetchStatus() {
        if (!currentJobId) return;

        try {
            const statusResponse = await fetch(`/status/${currentJobId}`);
            const statusData = await statusResponse.json();

            if (statusData.error) {
                statusMessage.innerHTML = `âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${statusData.error}`;
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                progressText.textContent = '';
                clearIntervals();
                submitButton.disabled = false;
                downloadButton.style.display = 'none';
                return;
            }

            if (statusData.canceled) {
                statusMessage.innerHTML = 'â›” à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸–à¸¹à¸à¸¢à¸à¹€à¸¥à¸´à¸à¹à¸¥à¹‰à¸§';
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                progressText.textContent = '';
                clearIntervals();
                submitButton.disabled = false;
                downloadButton.style.display = 'none';
                return;
            }

            if (statusData.total > 0) {
                const processed = statusData.processed;
                const total = statusData.total;
                const percentage = (processed / total) * 100;
                
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${Math.round(percentage)}%`;
                progressText.textContent = `à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹à¸¥à¹‰à¸§ ${processed} à¸ˆà¸²à¸ ${total} à¸£à¸²à¸¢à¸à¸²à¸£`;

                if (statusData.completed) {
                    statusMessage.innerHTML = 'âœ… Exportà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ!';
                    clearIntervals();
                    submitButton.disabled = false;
                    
                     // à¸«à¸²à¸à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¹à¸¥à¸°à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ ZIP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (statusData.zip_file_path) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ ZIP à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = `/download_report/${currentJobId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¸‹à¹ˆà¸­à¸™à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸•à¸²à¸¡à¸„à¸³à¸‚à¸­ "à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸›à¸¸à¹ˆà¸¡"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¸à¸£à¸“à¸µà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ ZIP (à¸­à¸²à¸ˆà¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ ZIP)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.innerHTML += '<br><span style="color:red; font-size:0.9em;">à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ ZIP à¹„à¸”à¹‰ à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Log à¸«à¸£à¸·à¸­ Terminal</span>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

                    // à¸„à¸³à¸™à¸§à¸“à¸ªà¸£à¸¸à¸›à¸œà¸¥
                    let csvSuccessCount = 0;
                    let csvFailedFiles = [];
                    let pdfSuccessCount = 0;
                    let pdfFailedFiles = [];
                    let skipCount = 0;
                    
                    if (statusData.results && statusData.results.length > 0) {
                        statusData.results.forEach(result => {
                            if (result.error_message === "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ NodeID à¸«à¸£à¸·à¸­ Interface ID à¹„à¸¡à¹ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ") {
                                skipCount++;
                            } else {
                                if (result.csv_success) {
                                    csvSuccessCount++;
                                } else {
                                    const identifier = (result.node_name && result.node_name.includes('_') && result.node_name.split('_').length >= 3) ? 
                                        `(${result.node_name.split('_').slice(-2).join('/')})` : 
                                        '';
                                    csvFailedFiles.push(`${result.node_name || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­'} ${identifier}`);
                                }
                                if (result.pdf_success) {
                                    pdfSuccessCount++;
                                } else {
                                    const identifier = (result.node_name && result.node_name.includes('_') && result.node_name.split('_').length >= 3) ? 
                                        `(${result.node_name.split('_').slice(-2).join('/')})` : 
                                        '';
                                    pdfFailedFiles.push(`${result.node_name || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­'} ${identifier}`);
                                }
                            }
                        });
                    }

                    summaryList.innerHTML = `
                        <li><span class="status-icon success-icon">âœ”</span> <b>CSV:</b> Exportà¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${csvSuccessCount} à¹„à¸Ÿà¸¥à¹Œ</li>
                        <li><span class="status-icon success-icon">âœ”</span> <b>PDF:</b> Exportà¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${pdfSuccessCount} à¹„à¸Ÿà¸¥à¹Œ</li>
                    `;
                    
                    if (skipCount > 0) {
                        const skipItem = document.createElement('li');
                        skipItem.innerHTML = `<span class="status-icon warning-icon">âš </span> <b>à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥:</b> ${skipCount} à¸£à¸²à¸¢à¸à¸²à¸£ (NodeID/Interface ID à¹„à¸¡à¹ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ)`;
                        summaryList.appendChild(skipItem);
                    }

                    if (csvFailedFiles.length > 0) {
                        const csvFailedItem = document.createElement('li');
                        csvFailedItem.innerHTML = `<span class="status-icon failure-icon">âœ˜</span> <b>CSV:</b> Exportà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${csvFailedFiles.length} à¹„à¸Ÿà¸¥à¹Œ`;
                        summaryList.appendChild(csvFailedItem);
                        
                        const failedList = document.createElement('ul');
                        failedList.style.fontSize = '0.9em';
                        failedList.style.marginLeft = '20px';
                        csvFailedFiles.forEach(fileName => {
                            const listItem = document.createElement('li');
                            listItem.textContent = fileName;
                            failedList.appendChild(listItem);
                        });
                        summaryList.appendChild(failedList);
                    }

                    if (pdfFailedFiles.length > 0) {
                        const pdfFailedItem = document.createElement('li');
                        pdfFailedItem.innerHTML = `<span class="status-icon failure-icon">âœ˜</span> <b>PDF:</b> Exportà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${pdfFailedFiles.length} à¹„à¸Ÿà¸¥à¹Œ`;
                        summaryList.appendChild(pdfFailedItem);
                        
                        const failedList = document.createElement('ul');
                        failedList.style.fontSize = '0.9em';
                        failedList.style.marginLeft = '20px';
                        pdfFailedFiles.forEach(fileName => {
                            const listItem = document.createElement('li');
                            listItem.textContent = fileName;
                            failedList.appendChild(listItem);
                        });
                        summaryList.appendChild(failedList);
                    }

                    resultsArea.style.display = 'block';
                }
            }
        } catch (error) {
            console.error("Error fetching status:", error);
            statusMessage.innerHTML = `âŒ à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°: ${error.message}`;
            clearIntervals();
            submitButton.disabled = false;
            downloadButton.style.display = 'none';
        }
    }

    async function fetchLogs() {
        if (!currentJobId) return;
        try {
            const logResponse = await fetch(`/logs/${currentJobId}`);
            const logData = await logResponse.json();
            if (logData.logs && logData.logs.length > 0) {
                // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ log à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸‹à¹‰à¸³à¸‹à¹‰à¸­à¸™
                const existingLogMessages = new Set(Array.from(logArea.children).map(div => div.textContent));

                logData.logs.forEach(log => {
                    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² logEntry à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¹€à¸à¸´à¹ˆà¸¡à¸‹à¹‰à¸³
                    if (!existingLogMessages.has(log)) {
                        const logEntry = document.createElement('div');
                        logEntry.textContent = log; 

                        // Assign class based on log content for coloring
                        if (log.startsWith('âœ…')) {
                            logEntry.classList.add('log-success');
                        } else if (log.startsWith('âŒ')) {
                            logEntry.classList.add('log-error');
                        } else if (log.startsWith('âš ï¸') || log.startsWith('â›”')) {
                            logEntry.classList.add('log-warning');
                        } else if (log.startsWith('ğŸ“Š') || log.startsWith('â–¶') || log.startsWith('ğŸ“‚') || log.startsWith('ğŸ“¥') || log.startsWith('ğŸ—‘ï¸') || log.startsWith('ğŸ§¹') || log.startsWith('âœ¨') || log.startsWith('ğŸ“')) {
                            logEntry.classList.add('log-info');
                        } else {
                            logEntry.classList.add('log-info'); // Default to info color
                        }
                        
                        logArea.appendChild(logEntry);
                        existingLogMessages.add(log); // à¹€à¸à¸´à¹ˆà¸¡ log à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™ Set
                    }
                });
                logArea.scrollTop = logArea.scrollHeight; // à¹€à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸›à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸ªà¸¸à¸”
            }
        } catch (error) {
            console.error("Error fetching logs:", error);
            // à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸ªà¸”à¸‡ error message à¸šà¸™ UI à¸–à¹‰à¸²à¸”à¸¶à¸‡ log à¹„à¸¡à¹ˆà¹„à¸”à¹‰
        }
    }
</script>

</body>
</html>